<!DOCTYPE html>
<html>
  <head>
    <title>Mixmax Canvas</title>
    <!-- Mixmax SDK -->
    <script defer src="https://d1xa36cy0xt122.cloudfront.net/v1/Mixmax.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js"></script>
    <style type="text/css">
        #sheet {
            border:1px solid black;
        }
    </style>
    <script type="text/javascript">
    function init() {
        //create new canvas object to increase scope
        //var staticCanvas = null;
        var canvas = new fabric.Canvas('sheet');
        document.getElementById("sheet").fabric = canvas;
        canvas.isDrawingMode = true;
        canvas.freeDrawingBrush.width = 5;
        canvas.freeDrawingBrush.color = "#ff0000";
        //staticCanvas = canvas;

        // get the dataURL from the URL
        var paramString = window.location.search;
        var searchParams = new URLSearchParams(paramString);
        var data = JSON.parse(searchParams.get("data"));
        if(data) {
            var dataURL = data["src"];
            // load it into the canvas
            var img = new Image();
            img.onload = function() {
                var fabricImage = new fabric.Image(img);
                canvas.add(fabricImage);
            }
            img.src = dataURL;
        }
    }

    function erase() {
        var m = confirm("Clear?");
        if (m) {
            document.getElementById("sheet").fabric.clear();
        }
    }

    function save() {
        // call done and pass it the image url of the canvas
        Mixmax.done({src: document.getElementById("sheet").fabric.toDataURL()});
    }

    function color(obj) {
        sheet = document.getElementById("sheet").fabric
        sheet.freeDrawingBrush.color = obj.id;
    }

    // load an image into the canvas
    function handleFiles(files) {
        sheet = document.getElementById("sheet").fabric
        file = files[0];
        var reader = new FileReader();
        reader.onload = function() {
            var dataURL = reader.result;
            // load it into the canvas
            var img = new Image();
            img.onload = function() {
                var fabricImage = new fabric.Image(img);
                sheet.add(fabricImage);
            }
            img.src = dataURL;
        }
        reader.readAsDataURL(file);
    }
    </script>
  </head>
  <body onload="init()">
        <div class="btn-group btn-block" style="display:inline-block;">

        <div id="container" style="padding:5px 0px 0px 0px;">
            <div id="red" onclick="color(this)" style="background:red; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="pink" onclick="color(this)" style="background:pink; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="fuchsia" onclick="color(this)" style="background:fuchsia; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="orange" onclick="color(this)" style="background:orange; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="yellow" onclick="color(this)" style="background:yellow; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="lime" onclick="color(this)" style="background:lime; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="green" onclick="color(this)" style="background:green; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="blue" onclick="color(this)" style="background:blue; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="purple" onclick="color(this)" style="background:purple; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
            <div id="black" onclick="color(this)" style="background:black; width:50px; height:50px;
            float:left; border: 1px;"></div>
            <div style="clear: both;"></div>
            <div id="white" onclick="color(this)" style="background:white; width:50px; height:50px; float:left;"></div>
            <div style="clear: both;"></div>
        </div>

        </div>

        <div style="display: inline-block;">
        <canvas id="sheet" width="400" height="400" style=" position:absolute; left:10%;border:2px solid;"></canvas>
        </div>

        <div class="container navbar-static-bottom footer">
            <div class="btn-group">
                <button type="button" id="#000000" class="btn btn-primary" onclick="save(this)">Save</button>
                <button type="button" id="#ffffff" class="btn btn-primary" onclick="erase(this)">Erase</button>
                <label class="btn btn-default btn-file">
                        Upload Image <input type="file" accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
                </label>
            </div>
        </div>

  </body>
</html>
